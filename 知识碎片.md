# 端到端测试Cypress

## 案例解析

看一段代码

```bash
#!/bin/bash

# By default we assume that the target for the CI is local
target=local

while :; do
    case $1 in
        -e|--env)
            if [ "$2" ]; then
                target=$2
                shift
            else
                die 'ERROR: "--env" requires a non-empty option argument. Allowed values local/ci'
            fi
            ;;
        --env=?*)
            target=${1#*=} # Delete everything up to "=" and assign the remainder.
            ;;
        *) # Default case: No more options, so break out of the loop.
          break
    esac
    shift
done

echo "Got the target: $target"
if [ "$target" == "ci" ]; then
    # On the CI server run the tests in parallel
    # This requires the projectId and the record_key to be configured in your environment variables. By default this is defined on the CI server
    echo "Got the Build ID: $BUILD_ID"
    yarn cypress run --headless \
    --record --key "$CYPRESS_RECORD_KEY" --ci-build-id $BUILD_ID \
    --parallel --group "Electrons on Gitlab CI" \
    --spec "cypress/integration/Regression_TestSuite/**/*.js"
else
    yarn cypress run --headless --browser chromium --spec "cypress/integration/Regression_TestSuite/**/*.js"
fi

```

解析：

```bash
target=local
```

标识测试环境，默认local；

```bash
while :; do
...
done
```

开启一个无限循环，开始处理命令行参数。

```bash
case $1 in
-e|--env)
    if [ "$2" ]; then
        target=$2
        shift
    else
        die 'ERROR: "--env" requires a non-empty option argument. Allowed values local/ci'
    fi
    ;;
--env=?)
    target=${1#=} # Delete everything up to "=" and assign the remainder.
    ;;
*)
    break
    ;;
esac
```

使用 `case` 语句处理**命令行参数**，检查参数是否是 `-e` 或 `--env`。如果是的话，它会将 `target` 变量设置为命令行参数的下一个值（`$2`）；

如果下一个值**不存在**，则会输出错误消息并**退出**脚本；

如果命令行参数是 `--env=`，则会将 `target` 变量设置为 `=` 后面的值。否则，如果命令行参数不是 `-e` 或 `--env`，则会跳出循环。

```bash
shift
```

将命令行参数向左移动一位，以便读取下一个参数。

```bash
echo "Got the target: $target"
```

输出 `target` 变量的值，以帮助你确认设置是否正确。

```bash
if [ "$target" == "ci" ]; then
    # On the CI server run the tests in parallel
    # This requires the projectId and the record_key to be configured in your environment variables. By default this is defined on the CI server
    echo "Got the Build ID: $BUILD_ID"
    yarn cypress run --headless \
    --record --key "$CYPRESS_RECORD_KEY" --ci-build-id $BUILD_ID \
    --parallel --group "Electrons on Gitlab CI" \
    --spec "cypress/integration/Regression_TestSuite/**/*.js"
else
    yarn cypress run --headless --browser chromium --spec "cypress/integration/Regression_TestSuite/**/*.js"
fi
```

如果target标识是ci，则在ci服务器上运行cypress；

使用 `yarn cypress run` 命令运行 Cypress 测试，并传递一些参数。这些参数包括：

- `--headless`：在无头模式下运行 Cypress 测试。
- `--record`：将测试结果上传到 Cypress Dashboard。
- `--key`：Cypress Dashboard 的记录密钥。
- `--ci-build-id`：CI 构建 ID，用于标识测试结果。
- `--parallel`：在 CI 服务器上并行运行测试。
- `--group`：将测试结果分组。
- `--spec`：指定要运行的测试文件。

如果 `target` 变量的值不是 `ci`，则表示要在本地运行测试，并且只需使用以下参数：

- `--headless`：在无头模式下运行 Cypress 测试。
- `--browser chromium`：指定要使用的浏览器。
- `--spec`：指定要运行的测试文件。

# webpack插件

|     plugin     |                             作用                             |
| :------------: | :----------------------------------------------------------: |
| SentryWebpack  | 集成 `Sentry` **错误日志**收集服务，`Sentry` 是一个开源的错误日志**收集和分析**服务，可以帮助开发人员更快地定位和修复错误。该插件主要用于在**生产环境**中收集应用程序的错误日志，并将其与特定的 **Git 提交**关联起来，以便更方便地进行错误分析和调试。 |
|    Workbox     | `WorkboxPlugin` 是一个用于生成 `Service Worker` 的插件，用于实现**离线缓存**和**资源预缓存**等功能。`Service Worker` 是在**浏览器**和**网络**之间运行的**脚本**，用于提供**离线访问**和**缓存资源**。该插件主要用于优化应用程序的性能和用户体验，特别是在网络不稳定或者没有网络的情况下。 |
|  Compression   | 该插件支持多种压缩算法，如 `gzip`、`brotli` 等。压缩构建**输出文件**可以有效地减小文件大小，从而提高应用程序的加载速度和性能。 |
| RetryChunkLoad | 用于重试加载 `Webpack` **拆分代码块**的插件。该插件主要用于处理**网络不稳定**或者网络超时等情况下的**代码块加载失败**问题。通过配置该插件，可以让应用程序在网络不稳定的情况下更加健壮和稳定。 |

## 使用打包进度条插件demo

创建一个新的项目**目录webpack**

1.添加**package.json**

```bash
npm init -y
```

2.安装webpack和progress-bar-webpack-plugin插件

```bash
npm install webpack webpack-cli progress-bar-webpack-plugin --save-dev
```

3.创建一个src/index.js文件

```bash
console.log("hello");
```

4.创建一个webpack.config.js文件

```js
const path = require('path');
const ProgressBarPlugin = require('progress-bar-webpack-plugin');

module.exports = {
  mode: 'development',
  entry: './src/index.js',
  output: {
    filename: 'bundle.js',
    path: path.resolve(__dirname, 'dist')
  },
  plugins: [
    new ProgressBarPlugin()
  ]
};
```

5.使用**插件**打包

```bash
npx webpack --progress
```

--progress参数以**百分比**的形式显示打包进度，如果添加了插件才会以其他形式显示进度

Webpack将会编译你的项目，并在命令行中显示打包进度条。完成后，你可以在dist目录下找到生成的bundle.js文件。

## craco打包添加进度条

以下是一个简单的**示例项目**，演示如何在**React应用程序**中添加`webpackbar`插件来显示进度条。

1. 创建React应用程序

首先，你需要创建一个React应用程序。你可以使用`create-react-app`工具来快速创建一个React应用程序。在命令行中执行以下命令：

```bash
npx create-react-app my-app
cd my-app
```

2. 安装webpackbar插件

在应用程序目录中，使用以下命令安装`webpackbar`插件：

```
npm install webpackbar --save-dev
```

这个命令会将`webpackbar`插件安装到应用程序中，并将其添加到`package.json`文件的`devDependencies`部分中。

3. 修改craco配置文件

在应用程序目录中，创建一个名为`craco.config.js`的新文件，并添加以下代码：

```javascript
const WebpackBar = require('webpackbar');

module.exports = {
  plugins: [
    {
      plugin: {
        overrideWebpackConfig: ({webpackConfig, cracoConfig, pluginOptions, context: {env, paths}}) => {
          webpackConfig.plugins.push(new WebpackBar());
          return webpackConfig;
        },
      },
    },
  ],
};
```

这个配置文件使用`webpackbar`插件来显示构建进度条。在Webpack配置中添加`webpackbar`插件的代码是通过`overrideWebpackConfig`函数实现的。

4. 启动应用程序

在应用程序目录中，使用以下命令启动React应用程序：

```
npm start
```

这个命令会启动开发服务器，并在浏览器中打开React应用程序。在构建过程中，`webpackbar`插件会显示构建进度条和其他信息。

5. 构建应用程序

在应用程序目录中，使用以下命令构建React应用程序：

```
npm run build
```

这个命令会生成一个生产环境的构建，并将其输出到`build`目录中。在构建过程中，`webpackbar`插件会显示构建进度条和其他信息。

# 命令行

查看最新修改或新增文件

```bash
dir /O-D /T:W
```

# 技巧

系统的**临时文件**存放位置配置在非C盘，通过**环境变量**配置，当磁盘内存紧缺时可以去那里清理

## 不同系统换行符

Visual Studio Code 编辑器中，你可以按 `Ctrl + Shift + H` 打开批量替换面板，然后启用正则表达式，并使用以下搜索和替换模式：

```
\r\n -> \n
```

包含的文件

```
./b_d/app/client/src
```

这将将所有回车符替换为 Unix 风格的换行符。

本地vscode编辑器也需要在eol设置中选择lf，

团队要是使用不同系统开发，需要在git配置设置

```bash
git config --global core.autocrlf false
```

高级写法：

```bash
git ls-files -z | xargs -0 perl -i -pe 's/\r$//g'
```

修改所有文件！

# yarn

查看当前的镜像源：

```
yarn config get registry
```

修改为淘宝镜像源：

```
yarn config set registry http://registry.npm.taobao.org
```

查看有效配置：

```
yarn config -v
```

# npm

## nrm

- `nrm ls`：列出当前可用的注册表。
- `nrm use <registry>`：切换到指定的注册表。
- `nrm add <registry> <url>`：添加一个自定义的注册表。
- `nrm del <registry>`：删除指定的注册表。

nrm 是一个用于管理 Node.js 包管理器（如 npm 和 Yarn）的注册表（registry）的工具。

# package.json

## 格式化脚本

```json
"prettify": "prettier --write \"src/**/*.ts\" \"src/**/*.tsx\" \"src/**/*.js\""
```

自动格式化 `src` 目录下的所有 `.ts`、`.tsx` 和 `.js` 文件

# lodash

**sortedByUniqBy**

排除了经过**迭代函数**处理后相等的相邻元素，同时保留第一个出现的元素。该方法会先对数组进行排序，然后再进行处理。

```js
const ff = [{label: 'aaa',value: 'A'},{label: 'aaa1',value: 'A'},{label: 'bbb',value: 'B'}]
_.sortedUniqBy(ff, (i) => i.value)
// 返回
{label: 'aaa', value: 'A'}
{label: 'bbb', value: 'B'}
```

对于下拉菜单的**options**，**value要唯一**；

对于不唯一的数据，有三种思路处理：

- 数据库去重；
- 后端去重；
- 前端去重；



# docker



# 样式积累

## hint效果

```css
.hint {
  background-color: #f5f7f9;
  border-radius: 4px;
  border: 1px solid #dcdcdc;
  border-left: 4px solid #346ddb;
  padding: 20px;
  margin: 10px 0;
}
```

使用

```html
<div class="hint" markdown="1">

</div>
```

# window

## 滚动到顶部--整个页面的顶部

```html
<!DOCTYPE html>
<html lang="ch-ZN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>js实现页面滚动返回顶部</title>
  <style>
    * {
      padding: 0px;
      margin: 0px;
    }

    div {
      width: 1200px;
      height: 300px;
      margin: 50px auto;
      font-size: 120px;
      line-height: 300px;
      text-align: center;
      color: #ffffff;
      background-color: #999999;
    }

    button {
      position: fixed;
      bottom: 40px;
      right: 40px;
      width: 60px;
      height: 60px;
      border: 0px;
      border-radius: 10px;
      font-size: 24px;
      line-height: 30px;
      text-align: center;
      color: #000;
      background-color: #c5e4ff;
      outline: none;
      cursor: pointer;
    }

    button:hover {
      color: #fff;
      background-color: #5fb4ff;
    }
  </style>
</head>

<body>
  <div>模块1</div>
  <div>模块2</div>
  <div>模块3</div>
  <div>模块4</div>
  <div>模块5</div>
  <div>模块6</div>
  <div>模块7</div>
  <div>模块8</div>
  <div>模块9</div>
  <button>返回顶部</button>
  <script>
    var btn = document.querySelector('button'); // 获取元素
    var timer; // 用来储存计时器的变量
    btn.addEventListener('click', function () {
      clearInterval(timer); // 先停止上次的计时器（防止连点）
      timer = setInterval(function () {
        // 判断是否已经滚动到了顶部
        if (window.pageYOffset != 0) {
          // 如果没到顶部就再移动一点距离（我这里是一次移动了50像素）
          window.scroll(0, Math.max(window.pageYOffset - 50, 0));
        } else {
          // 如果到顶部了就停止计时器
          clearInterval(timer);
        }
      }, 10);
    })
  </script>
</body>

</html>

```

## 滚动到顶部--容器内

```js
function toTop() {
  var sidebar = document.querySelector('.sidebar-nav');
  var content = document.querySelector('.markdown-section');

  sidebar.addEventListener('click', function () {
    content.scroll(0, -content.scrollHeight)
  });
}
```



# 问题&解决方案

## @sentry/cli

执行yarn，link步骤出现 `@sentry/cli@npm:1.75.2 couldn't be built successfully (exit code 1, logs can be found here: D:\temp\xfs-0d7a820d\build.log)`

```
[sentry-cli] Downloading from https://downloads.sentry-cdn.com/sentry-cli/1.75.2/sentry-cli-Windows-x86_64.exe
Error: Unable to download sentry-cli binary from https://downloads.sentry-cdn.com/sentry-cli/1.75.2/sentry-cli-Windows-x86_64.exe.
Error code: ECONNRESET
```

**解决**：

发现是**@sentry/webpack-plugin**依赖了**@sentry/cli**

1.根目录下新建.yarnrc

```
npmRegistryServer: "http://registry.npm.taobao.org/"
strict-ssl: false
```

单独安装@sentry/webpack-plugin

```
yarn add @sentry/webpack-plugin@1.18.9
```

## msys-crypto-1.1.dll

执行bash ./build.sh -DskipTests

日志有这条信息：D:/devTools/git/Git/usr/bin/rsync.exe: error while loading shared libraries: msys-crypto-1.1.dll: **cannot open shared object file**: No such file or directory

找到这个文件，放到**D:/devTools/git/Git/usr/bin**下就好了

## playwright安装慢

执行yarn，link 步骤第三方库playwright安装慢
